<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.0">
<title>Hystrix Examples&#8201;&#8212;&#8201;and a little bit more</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Noto+Serif:400,400italic,700,700italic|Droid+Sans+Mono:400">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Noto+Serif:400,400italic,700,700italic|Droid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-check-square-o:first-child,ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after,a[href^="mailto:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="book">
<div id="header">
<h1>Hystrix Examples&#8201;&#8212;&#8201;and a little bit more</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This started as a show case for Hystrix. As more tools have been added it might
also look for you as a walk through for different tools. Take a look around
and see what might fit your development environment.</p>
</div>
<div class="paragraph">
<p>&#8201;&#8212;&#8201;Alexander Schwartz (<a href="mailto:alexander.schwartz@gmx.net">alexander.schwartz@gmx.net</a>)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hystrix_make_your_application_resilient">1. Hystrix: Make your application resilient</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_build_you_application_to_handle_the_failure_of_external_services">1.1. Build you application to handle the failure of external services</h3>
<div class="paragraph">
<p>Your application has external runtime dependencies, like an external
validating service for data your user has entered, or the central CRM
of your company.</p>
</div>
<div class="paragraph">
<p>What will happen to your application when this external service has a problem?</p>
</div>
<div class="paragraph">
<p>In the worst case your application will become unavailable as well: The
screens of your application will freeze and not respond as the external
system doesn&#8217;t return with a response. Users and IT operations will call you
because they think it&#8217;s your fault and don&#8217;t suspect the external service.</p>
</div>
<div class="paragraph">
<p>But what should your application do, when the external service is unavailable?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>provide timely responses to the users</p>
</li>
<li>
<p>give a detailed error message to the users</p>
</li>
<li>
<p>provide fall backs when the other service is down</p>
</li>
<li>
<p>hooks for IT operations for monitoring to pin-point the problematic service</p>
</li>
<li>
<p>prevent overloading of the problematic service to avoid domino effects</p>
</li>
<li>
<p>automatic recovery once the problematic service is online again</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_what_hystrix_has_built_in_ready_to_use">1.2. What Hystrix has built in ready-to-use</h3>
<div class="paragraph">
<p>These problems are not new. Netflix has solved them for their video on demand service. In 2012 they made their solution open source.</p>
</div>
<div class="paragraph">
<p>To deliver the above, Hystrix has built in the following defaults:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>timeout for every request to an external system (default: 1000 ms)</p>
</li>
<li>
<p>limit of concurrent requests for external system (default: 10)</p>
</li>
<li>
<p>circuit breaker to avoid further requests (default: when more than 50% of all requests fail)</p>
</li>
<li>
<p>retry of a single request after circuit breaker has triggered (default: every 5 seconds)</p>
</li>
<li>
<p>interfaces to retrieve runtime information on request and aggregate level (there&#8217;s even a ready-to-use realtime dashboard for it)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It also shows you where you can place you fall back code.</p>
</div>
<div class="paragraph">
<p>Providing a detailed error message is then still a task for you.</p>
</div>
<div class="paragraph">
<p>For more details please have a look at <a href="http://hystrix.github.com" class="bare">http://hystrix.github.com</a>. The <a href="https://github.com/Netflix/Hystrix/wiki">wiki</a> gives detailed information how to use it and the mechanisms inside.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hystrix_at_work">1.3. Hystrix at work</h3>
<div class="paragraph">
<p>To seek Hystrix at work in an example application I&#8217;ve built a REST application that will be put under load soon. Let&#8217;s start out with the scenario first.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites_for_this_tutorial">2. Prerequisites for this tutorial</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_java_sdk_installed">2.1. Java SDK installed</h3>
<div class="paragraph">
<p>In order to run this application you&#8217;ll need to have Java installed. The minimum recommended version is Java JDK 7. I have performed my tests with Java JDK 8. Please download it from <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank">Oracle Java SE Download page</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_internet_connection_for_additional_downloads">2.2. Internet Connection for additional downloads</h3>
<div class="paragraph">
<p>In the process of the turorial you&#8217;ll need to download additional files from the internet. This includes i.e. Apache Tomcat and Apache Maven. All installations are scripted using small Powershell scripts. Expect a download an additional 100 MB during the tutorial.</p>
</div>
</div>
<div class="sect2">
<h3 id="_proxy_settings">2.3. Proxy settings</h3>
<div class="paragraph">
<p>When using Maven behind a proxy, please setup your proxy for protocols http and https in <code>tools\maven\apache-maven-3.2.x\conf\settings.xml</code>. You should specify the username and password only when this is necessary in your configuration. Please leave it blank otherwise. Please ensure that <code>localhost</code> is listed in <code>nonProxyHosts</code> otherwise the automatic deployment to the locally installed tomcat might not work.</p>
</div>
<div class="listingblock">
<div class="title">settings.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;proxy&gt;</span>
  <span class="tag">&lt;id&gt;</span>optional<span class="tag">&lt;/id&gt;</span>
  <span class="tag">&lt;active&gt;</span>true<span class="tag">&lt;/active&gt;</span>
  <span class="tag">&lt;protocol&gt;</span>http<span class="tag">&lt;/protocol&gt;</span>
  <span class="tag">&lt;username&gt;</span>proxyuser<span class="tag">&lt;/username&gt;</span>
  <span class="tag">&lt;password&gt;</span>proxypass<span class="tag">&lt;/password&gt;</span>
  <span class="tag">&lt;host&gt;</span>proxy.host.net<span class="tag">&lt;/host&gt;</span>
  <span class="tag">&lt;port&gt;</span>80<span class="tag">&lt;/port&gt;</span>
  <span class="tag">&lt;nonProxyHosts&gt;</span>localhost|local.net|some.host.com<span class="tag">&lt;/nonProxyHosts&gt;</span>
<span class="tag">&lt;/proxy&gt;</span>
<span class="tag">&lt;proxy&gt;</span>
  <span class="tag">&lt;id&gt;</span>optional<span class="tag">&lt;/id&gt;</span>
  <span class="tag">&lt;active&gt;</span>true<span class="tag">&lt;/active&gt;</span>
  <span class="tag">&lt;protocol&gt;</span>http<span class="tag">&lt;/protocol&gt;</span>
  <span class="tag">&lt;username&gt;</span>proxyuser<span class="tag">&lt;/username&gt;</span>
  <span class="tag">&lt;password&gt;</span>proxypass<span class="tag">&lt;/password&gt;</span>
  <span class="tag">&lt;host&gt;</span>proxy.host.net<span class="tag">&lt;/host&gt;</span>
  <span class="tag">&lt;port&gt;</span>80<span class="tag">&lt;/port&gt;</span>
  <span class="tag">&lt;nonProxyHosts&gt;</span>localhost|local.net|some.host.com<span class="tag">&lt;/nonProxyHosts&gt;</span>
<span class="tag">&lt;/proxy&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scenario_to_challenge_hystrix_external_bank_validation">3. Scenario to challenge Hystrix: External Bank validation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_iban_and_bic_validations">3.1. IBAN and BIC validations</h3>
<div class="paragraph">
<p>Most of Europe have changed to SEPA in early 2014. Instead of national account number and bank sorting code you now have a <a href="http://en.wikipedia.org/wiki/IBAN">IBAN</a> (International Bank Account Number) and <a href="http://en.wikipedia.org/wiki/ISO_9362">BIC</a> (Bank Identifier Code).</p>
</div>
<div class="paragraph">
<p>When customers enter their bank details on your website, you want to validate these. As the IBAN includes a check digit, you can implement this check.
The BIC doesn&#8217;t have a check digit, so you can only verify it by lookup in a dictionary.</p>
</div>
<div class="paragraph">
<p>Things get messy as the BIC might not match the IBAN, or the IBAN might
not be valid for direct debit/clearing.</p>
</div>
<div class="paragraph">
<p>The good news: there are external services that do the validation for you.</p>
</div>
</div>
<div class="sect2">
<h3 id="_simulating_an_external_iban_bic_validation_service">3.2. Simulating an external IBAN/BIC validation service</h3>
<div class="paragraph">
<p>As we want to show what Hystrix can do for us, we need a IBAN/BIC
validation service. We simulate the behaviour with a small Java procedure:</p>
</div>
<div class="listingblock">
<div class="title">IBANValidator.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">IBANValidator</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Logger</span> LOG = LoggerFactory.getLogger(IBANValidator.class);

    <span class="directive">private</span> <span class="directive">static</span> DynamicLongProperty timeToWait = DynamicPropertyFactory
            .getInstance().getLongProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hystrixdemo.sleep</span><span class="delimiter">&quot;</span></span>, <span class="integer">100</span>);


    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">synchronized</span> <span class="type">boolean</span> isValid(Account account)
            <span class="directive">throws</span> <span class="exception">InterruptedException</span> {
        <span class="keyword">if</span> (<span class="predefined-type">Thread</span>.currentThread().isInterrupted()) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">InterruptedException</span>();
        }
        <span class="type">long</span> t = timeToWait.get();
        LOG.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">waiting {} ms</span><span class="delimiter">&quot;</span></span>, t);
        <span class="keyword">if</span> (t &gt; <span class="integer">0</span>) {
            <span class="predefined-type">Thread</span>.sleep(t);
        }
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The core of the simulation is the static <code>isValid()</code> method. As it is synchronized, it will validate one account at a time.</p>
</div>
<div class="paragraph">
<p>To simulate the processing, we use <code>Thread.sleep()</code>. The delay is by default 100 ms. This can be configured at runtime using an <code>DynamicLongProperty</code>. See the chapter <a href="#archaius">Using runtime configuration</a> below. Changing the delay at runtime will help us later to try out different scenarios.</p>
</div>
<div class="paragraph">
<p>When someone interrupts the Thread while waiting for the <code>synchronized</code> lock or for <code>Thread.sleep()</code>, the method will throw an <code>InterruptedException</code>.</p>
</div>
<div class="paragraph">
<p>This is a standard Java feature that will be used by Hystrix to notify a service call that is taking too long.</p>
</div>
<div class="paragraph">
<p>You find this source code in the <code>hystrix-application</code> folder.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_a_real_application_with_jax_rs">4. Writing a real application with JAX-RS</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_jax_rs_as_a_standard_for_enterprise_restful_web_application">4.1. JAX-RS as a standard for enterprise RESTful web application</h3>
<div class="paragraph">
<p>JAX-RS is part of the JavaEE Standard. It defines how a JavaEE
application needs to be structured to respond to HTTP-REST-Calls.</p>
</div>
<div class="paragraph">
<p>REST calls have the following advantages:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>With their JSON-interface they can be interfaced easily from JavaScript clients.</p>
</li>
<li>
<p>The REST API can also be easily tested for functional and load testing (see <a href="#jmeter">Putting your application under load</a> below).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_resteasy_as_portable_jax_rs_implementation">4.2. RESTeasy as portable JAX-RS implementation</h3>
<div class="paragraph">
<p><a href="http://resteasy.jboss.org/">RESTEasy</a> by JBoss is a portable implementation of the standard. It adds also several enterprise
features like authentication and signatures.</p>
</div>
<div class="paragraph">
<p>As a portable implementation I can easily deploy it to a Tomcat
application server later.</p>
</div>
</div>
<div class="sect2">
<h3 id="_overview_of_classes_to_implement_a_jax_rs_service">4.3. Overview of classes to implement a JAX-RS service</h3>
<div class="paragraph">
<p>You find the example application in the folder <code>hystrix-application</code>.</p>
</div>
<div class="sect3">
<h4 id="_application_as_the_starting_point">4.3.1. Application as the starting point</h4>
<div class="paragraph">
<p>JAX-RS requires you to name all classes related to the REST part of your application. This class needs to extend <code>javax.ws.rs.core.Application</code>:</p>
</div>
<div class="listingblock">
<div class="title">HystrixApplication.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationPath</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">HystrixApplication</span> <span class="directive">extends</span> Application {
    <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Object</span>&gt; singletons = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;<span class="predefined-type">Object</span>&gt;();

    <span class="directive">public</span> HystrixApplication() {
        singletons.add(<span class="keyword">new</span> SimpleSaveAccount());
        singletons.add(<span class="keyword">new</span> HystrixSaveAccount());
        singletons.add(<span class="keyword">new</span> ValidationExceptionMapper());
        singletons.add(<span class="keyword">new</span> InterruptedExceptionMapper());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Object</span>&gt; getSingletons() {
        <span class="keyword">return</span> singletons;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This very basic setup lists lists the two REST endpoints <code>SimpleSaveAccount</code> and <code>HystrixSaveAccount</code> we will
lot at later plus an exception handler <code>ValidationExceptionMapper</code>.</p>
</div>
<div class="paragraph">
<p>It also defines that the URL <code>/api</code> will be used for all JAX-RS requests relative to the application.</p>
</div>
</div>
<div class="sect3">
<h4 id="_simplesaveaccount_as_rest_endpoint">4.3.2. SimpleSaveAccount as REST endpoint</h4>
<div class="paragraph">
<p>JAX-RS requires you to name all classes related to the REST part of your application. This class needs to extend <code>javax.ws.rs.core.Application</code>:</p>
</div>
<div class="listingblock">
<div class="title">SimpleSaveAccount.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/simple</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleSaveAccount</span> <span class="directive">extends</span> AbstractSaveAccount {

    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Response hello() {
        <span class="keyword">return</span> Response.status(Status.OK).entity(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>).build();
    }

    <span class="annotation">@POST</span>
    <span class="directive">public</span> Response save(Account account) <span class="directive">throws</span> ValidationException,
            <span class="exception">InterruptedException</span> {
        <span class="keyword">if</span> (!IBANValidator.isValid(account)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalid</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="local-variable">super</span>.saveToDatabase(account);
        <span class="keyword">return</span> Response.status(Status.OK).build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines for the URL <code>/simple</code> relative to the application defined above how to react on <code>GET</code> and <code>POST</code> requests.</p>
</div>
<div class="paragraph">
<p>A <code>GET</code>-Request will return with an empty <code>200 OK</code> response. This enables us to use a simple browser request to test the successful deployment of our application.</p>
</div>
<div class="paragraph">
<p>A <code>POST</code>-Request will have a parameter of type <code>Account</code>. If the account is invalid, it will throw an exception. Otherwise it will save the account. In our sample application the save operation is a dummy implementation that does nothing. After the save returned, the response is <code>200 OK</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exceptionmappers_to_handle_exceptions">4.3.3. ExceptionMappers to handle Exceptions</h4>
<div class="paragraph">
<p>Unhandled exceptions result in the application server to present a standard <code>500</code> error page that (depending on the application servers&#8217;s configuration) might also include a stack trace of the application.</p>
</div>
<div class="paragraph">
<p>To avoid this and to return REST-ful error messages exceptions are mapped by an <code>ExceptionMapper</code>.</p>
</div>
<div class="listingblock">
<div class="title">ValidationExceptionMapper.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Provider</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidationExceptionMapper</span> <span class="directive">implements</span>
        ExceptionMapper&lt;ValidationException&gt; {

    <span class="annotation">@Context</span>
    <span class="directive">private</span> HttpHeaders headers;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Response toResponse(ValidationException e) {
        <span class="keyword">return</span> Response.status(Status.BAD_REQUEST)
                .entity(<span class="keyword">new</span> Message(e.getMessage()))
                .type(headers.getMediaType()).build();
    }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_equip_your_application_with_hystrix">5. Equip your application with Hystrix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ensuring_a_clean_start_up_and_shut_down_of_hystrix">5.1. Ensuring a clean start up and shut down of Hystrix</h3>
<div class="paragraph">
<p>When you want to run code at the start and at the end of a JEE Web application, the place for this is <code>@WebListener</code>. The servlet container will scan for classes with this annotation and run their <code>contextInitialized()</code> and <code>contextDestroyed()</code> methods.</p>
</div>
<div class="paragraph">
<p>To start up Hystrix there is nothing to do; you can just go ahead and use it.</p>
</div>
<div class="paragraph">
<p>I recommend a shut down of Hystrix as it starts several thread pools to do its job. Just add the line</p>
</div>
<div class="listingblock">
<div class="title">HystrixSetupListener.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// shutdown all thread pools; waiting a little time for shutdown</span>
Hystrix.reset(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As Hystrix uses Archaius as a default for runtime configuration, we should shut down it as well.</p>
</div>
<div class="listingblock">
<div class="title">HystrixSetupListener.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// shutdown configuration listeners that might have been activated by</span>
<span class="comment">// Archaius</span>
<span class="keyword">if</span> (ConfigurationManager.getConfigInstance() <span class="keyword">instanceof</span> DynamicConfiguration) {
    ((DynamicConfiguration) ConfigurationManager.getConfigInstance())
            .stopLoading();
} <span class="keyword">else</span> <span class="keyword">if</span> (ConfigurationManager.getConfigInstance() <span class="keyword">instanceof</span> ConcurrentCompositeConfiguration) {
    ConcurrentCompositeConfiguration config =
            ((ConcurrentCompositeConfiguration) ConfigurationManager
                    .getConfigInstance());
    <span class="keyword">for</span> (AbstractConfiguration innerConfig : config.getConfigurations()) {
        <span class="keyword">if</span> (innerConfig <span class="keyword">instanceof</span> DynamicConfiguration) {
            ((DynamicConfiguration) innerConfig).stopLoading();
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_external_interfaces_as_a_hystrix_command">5.2. Wrap external interfaces as a Hystrix Command</h3>
<div class="paragraph">
<p>The core of the application is now set up. To benefit from Hystrix each call needs to be wrapped as a Hystrix command.</p>
</div>
<div class="listingblock">
<div class="title">HystrixSaveAccount.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">IBANValidatorCommand</span> <span class="directive">extends</span> HystrixCommand&lt;<span class="predefined-type">Boolean</span>&gt; {
    <span class="directive">private</span> Account account;

    <span class="directive">protected</span> IBANValidatorCommand(Account account) {
        <span class="local-variable">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory
                .asKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">iban</span><span class="delimiter">&quot;</span></span>)));
        <span class="local-variable">this</span>.account = account; <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">Boolean</span> run() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">return</span> IBANValidator.isValid(account); <i class="conum" data-value="3"></i><b>(3)</b>
    }

}

<span class="annotation">@POST</span>
<span class="directive">public</span> Response save(Account account) <span class="directive">throws</span> ValidationException,
        <span class="exception">InterruptedException</span> {
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (!<span class="keyword">new</span> IBANValidatorCommand(account).execute()) { <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalid</span><span class="delimiter">&quot;</span></span>);
        }
    } <span class="keyword">catch</span> (HystrixRuntimeException e) { <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="keyword">if</span> (e.getCause() <span class="keyword">instanceof</span> <span class="exception">InterruptedException</span>) {
            <span class="keyword">throw</span> (<span class="exception">InterruptedException</span>) e.getCause();
        }
        LOG.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">problem</span><span class="delimiter">&quot;</span></span>, e);
        <span class="keyword">return</span> Response.status(Status.SERVICE_UNAVAILABLE).build();
    }
    <span class="local-variable">super</span>.saveToDatabase(account);
    <span class="keyword">return</span> Response.status(Status.OK).build();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>constructing the wrapper</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>memorizing the parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>calling the original code</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>taking care of the additional runtime exception that originates from an exception of the services, or from the resilience functionality of Hystrix</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When there is a problem with the Hystrix command there will be a HystrixRuntimeException. This will occor in two cases:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Hystrix circuit breaker or time out handler are activated.</p>
</li>
<li>
<p>The original command throws an exception.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to handle the exceptions of your service as before, you will need to unwrap them.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_starting_up_the_application_container">6. Starting up the application container</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_apache_tomcat_is_is_an_easy_to_use_servlet_container">6.1. Apache Tomcat is is an easy to use servlet container</h3>
<div class="paragraph">
<p><a href="http://tomcat.apache.org">Apache Tomcat</a> is a servlet container. It can run JavaEE Web applications like our JAX-RS applications.</p>
</div>
<div class="paragraph">
<p>Tomcat Version 8 is implementing the JavaEE 7 standard supporting
the latest APIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_and_running_apache_tomcat">6.2. Installing and running Apache Tomcat</h3>
<div class="paragraph">
<p>Installation is straight forward: After the download only few
configuration steps are necessary.</p>
</div>
<div class="paragraph">
<p>All of these have been prepared in the script <code>tools/tomcat/run-tomcat.bat</code>. When you start it the first time, the the script will download the installation archive, unzip it and update the configuration.</p>
</div>
<div class="sect3">
<h4 id="_activated_apache_tomcat_features">6.2.1. Activated Apache Tomcat features</h4>
<div class="paragraph">
<p>The following features are being set up using the automatic installation:</p>
</div>
<div class="paragraph">
<p>In <code>setenv.bat</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allow Java remote debugging on port 1044<br></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=1044</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In <code>context.xml</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Activate <code>antiResourceLocking</code> to allow hot-deployment of applications when running Microsoft Windows as operating system</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In <code>tomcat-users.xml</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setup an user <code>deploy</code> with password <code>deploy</code> to automatically deploy an application</p>
</li>
<li>
<p>Setup an user <code>tomcat</code> with password <code>tomcat</code> to allow login on the management GUI</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_apache_tomcat_installation">6.2.2. Testing the Apache Tomcat installation</h4>
<div class="paragraph">
<p>To test the application point your browser at <a href="http://localhost:8080" class="bare">http://localhost:8080</a>. You should see an Apache Tomcat start page with the welcome message (see figure <a href="#img-tomcatwelcome">Apache Tomcat Welcome Message</a>).</p>
</div>
<div id="img-tomcatwelcome" class="imageblock">
<div class="content">
<img src="manual/tomcatwelcome.png" alt="Tomcat Welcome Message">
</div>
<div class="title">Figure 1. Apache Tomcat Welcome Message</div>
</div>
<div class="paragraph">
<p>Click on the button <strong>Manager App</strong> and you will be asked for a user name and password. Use the user <code>tomcat</code> with the password stated above to log in.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="archaius">7. Using runtime configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_runtime_configuration_will_get_you_credits">7.1. Runtime configuration will get you credits</h3>
<div class="paragraph">
<p>If you would write applications that would require a restart every
time you change a setting, it will deter your users as you will have
a downtime.</p>
</div>
<div class="paragraph">
<p>How nice if you could change all your settings at runtime! No more night shifts for IT operating to change parameters and restart the services!</p>
</div>
</div>
<div class="sect2">
<h3 id="_netflixx_archaius_to_the_rescue">7.2. Netflixx Archaius to the rescue</h3>
<div class="paragraph">
<p>Hystrix is integrated already with  <a href="https://github.com/Netflix/archaius" target="_blank">Archaius</a> that handles runtime
configuration for you. When implementing our <code>IBANValidator</code> you&#8217;ve seen the dynamic property we introduced:</p>
</div>
<div class="listingblock">
<div class="title">IBANValidator.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> DynamicLongProperty timeToWait = DynamicPropertyFactory
        .getInstance().getLongProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hystrixdemo.sleep</span><span class="delimiter">&quot;</span></span>, <span class="integer">100</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create a dynamic property. When we access it, it will always return the most up to date value for it. When the external configuration doesn&#8217;t define a value the default of 100 will be returned.</p>
</div>
<div class="paragraph">
<p>In more advanced situations you can also register a callback to be notified whenever a configuration changes. Please refer to the <a href="https://github.com/Netflix/archaius/wiki" target="_blank">Archaius Wiki</a> to find out more about it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_runtime_configuration_works_in_this_project">7.3. How runtime configuration works in this project</h3>
<div class="paragraph">
<p>Archaius supports multiple back ends to store configuration data. In our setup all configuration is stored in a Java properties file. Archaius checks this file every second.</p>
</div>
<div class="paragraph">
<p>This is configured as follows:</p>
</div>
<div class="listingblock">
<div class="title">setenv.bat</div>
<div class="content">
<pre class="CodeRay highlight"><code>-Darchaius.configurationSource.additionalUrls=file:///%CATALINA_HOME%/../archaius.properties
-Darchaius.fixedDelayPollingScheduler.delayMills=1000
-Darchaius.fixedDelayPollingScheduler.initialDelayMills=1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows you change the dynamic property above</p>
</div>
<div class="listingblock">
<div class="title">archaius.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code>hystrixdemo.sleep=10</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will override the default setting with 10.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_the_hystrix_command_via_archaius">7.4. Configuring the Hystrix command via Archaius</h3>
<div class="paragraph">
<p>All Hystrix settings can be configured on default and on command level. Please refer to the <a href="https://github.com/Netflix/Hystrix/wiki/Configuration">Configuration Wiki of Hystrix</a> for an in-depth discussion. This will now show the core parameters and configure them on default level:</p>
</div>
<div class="listingblock">
<div class="title">archaius.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code># Should Hystrix interrupt a command that is overdue?
# default: true
hystrix.command.default.execution.isolation.thread.interruptOnTimeout=true

# How long should Hystrix wait for a response?
# default: 1000
hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=1000

# How many errors are allowed before the circuit breaker is activated?
# default: 50 (must be greater than 0,
# 100 means no breaking despite of errors)
hystrix.command.default.circuitBreaker.errorThresholdPercentage=50

# How many requests are needed in the time span to trigger the circuit breaker?
# default: 20
hystrix.command.default.circuitBreaker.requestVolumeThreshold=20

# After what time (in ms) should the circuit breaker try a single request?
# default: 5000
hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds=5000</code></pre>
</div>
</div>
<div class="paragraph">
<p>To give these parameters a try you should set up a load test. You&#8217;ll see in the next chapter how you can do this. But first deploy the application to this freshly installed Tomcat!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_and_deploying_the_application">8. Building and deploying the application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_build_configuration_based_on_conventions_with_apache_maven">8.1. Build Configuration based on conventions with Apache Maven</h3>
<div class="paragraph">
<p><a href="http://maven.apache.org/" target="_blank">Apache Maven</a> as a build system you the following advantages:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Project layout based on conventions (i.e. your source files are in <code>src/main/java</code>)</p>
</li>
<li>
<p>Management of binary artefacts including transitive dependencies</p>
</li>
<li>
<p>A lot of plugins to automate your build</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installing_apache_maven">8.2. Installing Apache Maven</h3>
<div class="paragraph">
<p>This process has been automated for you. The first time you start <code>tools/maven/run-maven.bat</code> Maven is downloaded and installed.</p>
</div>
<div class="paragraph">
<p>The following configuration is applied:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>All dependencies will be downloaded to the folder <code>tools/maven/m2</code>. This folder will be used as a cache: All dependencies will be only downloaded once.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_packaging_and_deploying_your_application_to_tomcat">8.3. Packaging and deploying your application to Tomcat</h3>
<div class="paragraph">
<p>To do this run <code>hystrix-application/maven-package-deploy.bat</code>. <strong>Please ensure that your Apache Tomcat is running,</strong> as Maven will deploy your application into the running Apache Tomcat.</p>
</div>
<div class="paragraph">
<p>The steps executed by Maven <code>mvn clean package cargo:redeploy</code> included in the Batch-file:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clean up the build folder <code>target</code>,</p>
</li>
<li>
<p>download all dependencies from public Maven repositories if they haven&#8217;t been downloaded yet,<br>
(This might take a while on the first run depending on the speed of your Internet connection.)</p>
</li>
<li>
<p>compile all Java sources,</p>
</li>
<li>
<p>package a WAR file in the <code>target</code> folder,</p>
</li>
<li>
<p>deploy it to your running Tomcat instance.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To test that your application has been deployed successfully, open the URL <a href="http://localhost:8080/hystrixapp/api/simple" target="_blank">http://localhost:8080/hystrixapp/api/simple</a> in your browser.
You should get the response <code>Hello world</code> to show you that everything has been set up correctly.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jmeter">9. Putting your application under load</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_apache_jmeter_is_free_and_open_source_load_testing">9.1. Apache JMeter is free and open source load testing</h3>
<div class="paragraph">
<p><a href="http://jmeter.apache.org/" target="_blank">Apache JMeter</a> allows you to create
and run load tests simulating the load of multiple users using
a single PC.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_apache_jmeter">9.2. Installing Apache JMeter</h3>
<div class="paragraph">
<p>This process has been automated for you. The first time you start <code>tools/maven/run-jmeter.bat</code> JMeter is downloaded and installed.</p>
</div>
<div class="paragraph">
<p>The following defaults are applied:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Whenever you run JMeter using the script above, the load testing script <code>hystrixSaveAccount.jmx</code> is opened.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You will see the <a href="#img-jmeterwelcome">Apache JMeter Start Screen</a>.</p>
</div>
<div id="img-jmeterwelcome" class="imageblock">
<div class="content">
<img src="manual/jmeterwelcome.png" alt="JMeter Start Screen">
</div>
<div class="title">Figure 2. Apache JMeter Start Screen</div>
</div>
</div>
<div class="sect2">
<h3 id="_simulating_multiple_users">9.3. Simulating multiple users</h3>
<div class="paragraph">
<p>You can vary the number of simulated users by changing the number of threads. In this script the number of users is configured to be 20.</p>
</div>
<div class="paragraph">
<p>A test with JMeter has the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>choose the number of users (aka threads)</p>
</li>
<li>
<p>press the play <span class="image"><img src="manual/jmeter-play.png" alt="Play" title="Play"></span> button to start the workers</p>
</li>
<li>
<p>press the stop <span class="image"><img src="manual/jmeter-stop.png" alt="Stop" title="Stop"></span> button to stop the workers</p>
</li>
<li>
<p>Watch the summary report to see the timing of the requests and how many requests succeed and fail</p>
</li>
<li>
<p>Watch the log file of Apache Tomcat for exceptions and other log messages</p>
</li>
<li>
<p>Change the Archaius runtime configuration and see how the behaviour of the system changes (see section <a href="#archaius">Using runtime configuration</a> for the details).</p>
</li>
<li>
<p>press the clean <span class="image"><img src="manual/jmeter-clean.png" alt="Clean" title="Clean"></span> button to clear the results from JMeter</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When you change the number of users (aka threads) this will become effective only after you stop/start the workers
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aggregating_hystrix_runtime_information_in_a_cluster">10. Aggregating Hystrix runtime information in a cluster</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_turbine_aggregates_runtime_information">10.1. Turbine aggregates runtime information</h3>
<div class="paragraph">
<p><a href="https://github.com/Netflix/Turbine">Netflix Turbine</a> is a web application that connects to instances of your Hystrix application in a cluster and aggregates the information.</p>
</div>
<div class="paragraph">
<p>It does this in real time. The results will be updated every 0.5 seconds.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_and_running_turbine">10.2. Installing and running Turbine</h3>
<div class="paragraph">
<p>The installation has been scripted for you: you need to run <code>tools/turbine/maven-package-deploy.bat</code>.</p>
</div>
<div class="paragraph">
<p>The current installation will re-package the 0.4 version of Turbine and add to it the latest (yet unreleased) changes to allow easy re-deployment. Please have a look into <code>pom.xml</code> to see how you can adopt an already packaged WAR file to your environment.</p>
</div>
<div class="paragraph">
<p>You can open the URL <a href="http://localhost:8080/turbine/turbine.stream" class="bare">http://localhost:8080/turbine/turbine.stream</a> in a Google Chrome browser to see the stream of events. If there are no Hystrix requests, you&#8217;ll see only "ping" messages. You can&#8217;t test this with Mozilla Firefox or Microsoft Internet Explorer as they will open only a file download dialogue.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_for_turbine">10.3. Configuration for Turbine</h3>
<div class="sect3">
<h4 id="_configuration_turbine_metadata">10.3.1. Configuration Turbine metadata</h4>
<div class="paragraph">
<p>Turbine uses the same configuration mechanism as Hystrix: Archaius. See chapter "<a href="#archaius">Using runtime configuration</a> for more information. The following configuration has already been set up for you in <code>archaius.properties</code>:</p>
</div>
<div class="listingblock">
<div class="title">archaius.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code>turbine.instanceUrlSuffix=:8080/hystrixapp/hystrix.stream
turbine.ConfigPropertyBasedDiscovery.default.instances=localhost</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>turbine.instanceUrlSuffix</code>: This URL suffix needs to be the same for all applications in the cluster. Turbine uses this Endpoint to receive a stream of runtime information.</p>
</div>
<div class="paragraph">
<p><code>turbine.ConfigPropertyBasedDiscovery.default.instances</code>: This lists the hosts Turbine should poll information from. In a production system there are mechanisms to discover hosts automatically. In our test scenario a list is sufficient as we have only one host.</p>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_your_application_for_turbine">10.3.2. Preparing your application for Turbine</h4>
<div class="paragraph">
<p>To have you application publishing the information on the URL suffix above, you&#8217;ll need to add a servlet to your application. This has already been packaged for you. You&#8217;ll just need to include as a dependency of your application in <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="error">&lt;</span>!- include metrics event stream --<span class="error">&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.netflix.hystrix<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>hystrix-metrics-event-stream<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${hystrix}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you register it in <code>web.xml</code> as a servlet:</p>
</div>
<div class="listingblock">
<div class="title">web.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="error">&lt;</span>!- include metrics event stream --<span class="error">&gt;</span>
<span class="tag">&lt;servlet&gt;</span>
    <span class="tag">&lt;description&gt;</span><span class="tag">&lt;/description&gt;</span>
    <span class="tag">&lt;display-name&gt;</span>HystrixMetricsStreamServlet<span class="tag">&lt;/display-name&gt;</span>
    <span class="tag">&lt;servlet-name&gt;</span>HystrixMetricsStreamServlet<span class="tag">&lt;/servlet-name&gt;</span>
    <span class="tag">&lt;servlet-class&gt;</span>com.netflix.hystrix.contrib.metrics.eventstream.HystrixMetricsStreamServlet<span class="tag">&lt;/servlet-class&gt;</span>
<span class="tag">&lt;/servlet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can open the URL <a href="http://localhost:8080/hystrixapp/hystrix.stream" class="bare">http://localhost:8080/hystrixapp/hystrix.stream</a> in a Google Chrome browser to see the stream of events. If there are no Hystrix requests, you&#8217;ll see only "ping" messages. You can&#8217;t test this with Mozilla Firefox or Microsoft Internet Explorer as they will open only a file download dialogue.</p>
</div>
<div class="paragraph">
<p>To visualize it, see the next chapter about Hystrix dashboard.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_displaying_hystrix_runtime_information_in_a_browser">11. Displaying Hystrix runtime information in a Browser</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_hystrix_dashboard_displays_a_realtime_dashboard">11.1. Hystrix Dashboard displays a Realtime Dashboard</h3>
<div class="paragraph">
<p><a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-dashboard" target="_blank">Hystrix Dashboard</a> is part of the Hystrix distribution. It displays runtime information about every Hystrix command and thread pool for the last few minutes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_and_running_hystrix_dashboard">11.2. Installing and running Hystrix Dashboard</h3>
<div class="paragraph">
<p>The installation has been scripted for you: you need to run <code>tools/hystrix-dashboard/maven-package-deploy.bat</code>.</p>
</div>
<div class="paragraph">
<p>The current installation will re-package the 1.3.16 version of Hystrix dashboard and add to it the latest (yet unreleased) changes to allow running it without an internet connection. Please have a look into <code>pom.xml</code> to see how you can adopt an already packaged WAR file to your environment.</p>
</div>
<div class="paragraph">
<p>Open your browser on <a href="http://localhost:8080/hystrix-dashboard/" class="bare">http://localhost:8080/hystrix-dashboard/</a>. Press <b class="button">Monitor Stream</b> with the default setting to display the aggregated stream from the Turbine dashboard.</p>
</div>
<div class="paragraph">
<p>Enter <code><a href="http://localhost:8080/hystrixapp/hystrix.stream" class="bare">http://localhost:8080/hystrixapp/hystrix.stream</a></code> to retrieve the information from the application directly.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_behaviour_of_hystrix_under_load">12. Behaviour of Hystrix under load</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_to_load_scenarios_for_hystrix">12.1. Introduction to Load Scenarios for Hystrix</h3>
<div class="paragraph">
<p>Now we have a complete setup: an application, a driver for the load, and a real time dashboard. You are now ready to see the behaviour of Hystrix.</p>
</div>
<div class="paragraph">
<p>The number of threads in JMeter will remain constant for all scenarios. The scenarios will differ only in their setting of <code>hystrixdemo.sleep</code> in <code>archaius.properties</code>. This will simulate a n IBAN/BIC validation that is gradually getting slower and slower.</p>
</div>
<div class="paragraph">
<p>The delay between requests in the thread pool is 1 second. The time of the service to respond is not compensated by the delay: the longer the response time is, the fewer requests per second we will see. When there is no delay at all, we would see 20 requests per second, as we have 20 workers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_fast_response_10_ms">12.2. A fast response: 10 ms</h3>
<div class="paragraph">
<p>Starting with a response time of 10 ms we see a very well behaving system: The throughput is about 18 requests per second.</p>
</div>
<div class="paragraph">
<p>The number of active threads is idling between one and two. The median service time is about 10 ms, the mean slightly above.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="manual/dashboard_10ms.png" alt="Hystrix Dashboard: 10 ms service delay">
</div>
<div class="title">Figure 3. Hystrix Dashboard: 10 ms service delay</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_medium_response_70_ms">12.3. A medium response: 70 ms</h3>
<div class="paragraph">
<p>Now change the delay to 70 ms. Save the file. Archaius will pick up the new value within a seconds. Our IBAN/BIC service will get slower.</p>
</div>
<div class="paragraph">
<p>You will see an immediate effect on the Dashboard. After a short time the values in the dashboard will be re-calculated.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="manual/dashboard_70ms.png" alt="Hystrix Dashboard: 70 ms service delay">
</div>
<div class="title">Figure 4. Hystrix Dashboard: 70 ms service delay</div>
</div>
<div class="paragraph">
<p>With 13.6 requests per second and a delay of 70 ms in the service is now saturated. 13.7 req/s multiplied with 70 ms is almost 1 second working time per second.</p>
</div>
<div class="paragraph">
<p>You also see that the number of active threads has increased to 6.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_late_response_100_ms">12.4. A late response: 100 ms</h3>
<div class="paragraph">
<p>Change the delay to 100 ms. Save the file. You&#8217;ll see the dashboard change.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="manual/dashboard_100ms.png" alt="Hystrix Dashboard: 100 ms service delay">
</div>
<div class="title">Figure 5. Hystrix Dashboard: 100 ms service delay</div>
</div>
<div class="paragraph">
<p>The number of active threads iterates between 9 and 10. (Please ignore the "queue size", this is not active as queueing is disabled by default). Indicated as a yellow number some requests receive a time out while they are waiting at the synchronized lock on the simulated IBAN server. Purple indicates the number of requests that are rejected when there is no space in the queue.</p>
</div>
<div class="paragraph">
<p>The dashboard shows you that 26 percent of all requests fail.</p>
</div>
<div class="paragraph">
<p>If the service wouldn&#8217;t have been wrapped as a service, we would see an overload situation and with long response times. With Hystrix the response times in the 99 percent tier are still around one second for the successful requests.</p>
</div>
<div class="paragraph">
<p>The circuit is closed, meaning that Hystrix considers the service to be functional (although some requests are rejected).</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_critical_response_200_ms">12.5. A critical response: 200 ms</h3>
<div class="paragraph">
<p>Now try 200 ms. Save the file. The dashboard will change again.</p>
</div>
<div class="paragraph">
<p>That you see is a that the Circuit changes between open and closed. Therefore the following picture is a combination of two screen shots.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="manual/dashboard_200ms.png" alt="Hystrix Dashboard: 200 ms service delay">
</div>
<div class="title">Figure 6. Hystrix Dashboard: 200 ms service delay</div>
</div>
<div class="paragraph">
<p>The ratio of failed commands is now more than 50 percent, therefore the circuit breaker kicks in. Every five seconds it tries on request (that is answered within 200 ms), resets the statistics and then closes again.</p>
</div>
<div class="paragraph">
<p>As the statistics are reset on each opening circuit, you can&#8217;t trust the dashboard. Please have a look in JMeter in the Summary report. Reset it (as it will by now contain results from the previous setups), and wait a short time. It will show you that about 65 percent of the requests fail.</p>
</div>
</div>
<div class="sect2">
<h3 id="_an_eternity_1500_ms">12.6. An eternity: 1500 ms</h3>
<div class="paragraph">
<p>The final setting: 1500 ms. Save the file. Watch the dashboard.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="manual/dashboard_1500ms.png" alt="Hystrix Dashboard: 1500 ms service delay">
</div>
<div class="title">Figure 7. Hystrix Dashboard: 1500 ms service delay</div>
</div>
<div class="paragraph">
<p>As the time out is 1000 ms for the commands, 100 percent of the requests fail. The circuit is no permanently open. Even the retry every 5 seconds will not close it again as this single request is too slow.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hystrix_don_t_waste_resources_by_queueing_requests">12.7. Hystrix: Don&#8217;t waste resources by queueing requests</h3>
<div class="paragraph">
<p>The examples show that Hystrix does its job very effectively:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It  will forward as many requests as possible to the service to process them.</p>
</li>
<li>
<p>Any other requests are returned to the sender as unsuccessful as early as possible.</p>
</li>
<li>
<p>No caller waits longer than the 1 second time out for a response</p>
</li>
<li>
<p>Queues require resources, and Hystrix efficiently minimizes queueing inside the system. It is limited to the ten concurrent requests processed by the thread pool.</p>
</li>
<li>
<p>A burst in requests is reflected at the earliest boundary instead of overloading the backend service</p>
</li>
<li>
<p>When the back end services are overloaded for one or the other reason, the circuit breaker in front will give the backend services a break to recover.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Well done, Hystrix!</p>
</div>
<div class="paragraph">
<p>Please feel free to try your own variations: enable queueing, change the number of threads, or try out any other Hystrix setting.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-08-24 20:29:24 MEZS
</div>
</div>
</body>
</html>